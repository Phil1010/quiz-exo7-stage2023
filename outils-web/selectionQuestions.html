<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Selection questions</title>



    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Pour le clipboard -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Pour le Toast -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>
    <style>
        .dropdown-trigger {
            width: 254px;
        }

        .btns-dropdown {
            width: 240px;
        }
    </style>
</head>

<body>
    <div class="row">
        <div class="col s6">
            <input type="text" id="motRechercher" placeholder="Entrer un mot clé" onkeydown="handleKeyPress(event)">
        </div>
    </div>

    <div class="row">
        <div class="col s3">
            <h6>Résultats de la recherche :</h6>
            <div class="card white">
                <div class="card-content" style="height: calc(100vh - 146px); overflow: scroll">
                    <div id="itemsContainer" class="items"></div>
                </div>
            </div>
        </div>
        <div class="col s9">
            <div class="container">
                <h6>Questions sélectionnées :</h6>
                <div class="card white">
                    <div class="card-content" style="height: calc(70vh - 30px); overflow: scroll">
                        <div id="questionsContainer" class="questions"></div>
                    </div>
                </div>
                <h6>Options :</h6>
                <div>
                    <a class="dropdown-trigger btn" href="#" data-target="dropdown1">Options d'export<i
                            class="material-icons right">arrow_drop_down</i></a>
                    <ul id="dropdown1" class="dropdown-content">
                        <li> <!-- OUVRIR DANS OVERLEAF -->
                            <form action="https://www.overleaf.com/docs" method="post" target="_blank"
                                name="formulaire2">
                                <textarea id="codeLatex" rows="8" cols="60" name="snip"
                                    style="display: none;"></textarea>
                                <button class="btn btns-dropdown" type="submit" name="action"
                                    onclick="ouvrirAvecOverleaf()" style="margin: 1vh;">
                                    <i class=" material-icons left">open_in_new</i>
                                    Overleaf
                                </button>
                            </form>
                        </li>
                        <li> <button class="btn btns-dropdown" id="exportBtn" onclick="ouvrirCodeAMC()"
                                style="margin: 1vh;"><i class=" material-icons left">open_in_new</i>Exporter en
                                AMC</button></li>
                        <li><button class="btn btns-dropdown" id="ouvrirCodeMoodle" onclick="ouvrirCodeMoodle()"
                                style="margin: 1vh;">
                                <i class=" material-icons left">open_in_new</i>Exporter
                                en Moodle</button></li>
                    </ul>

                    <button id="btn" class="btn" data-clipboard-target="#url" onclick="copierLien()"
                        style="margin: 1vh;">
                        <i class="material-icons left">content_copy</i>
                        Copier le lien
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var dropdownElems = document.querySelectorAll('.dropdown-trigger');
        M.Dropdown.init(dropdownElems);
    });
    // le mot rechercher dans l'input
    let motRechercher = document.getElementById('motRechercher');
    // les résultats de la recherche afficher dans la div "resultats de la recherche"
    let resultatsDeRecherche = [];
    // la liste des numéros de questions sélectionnées
    let questionsSelectionnees = [];
    // la div qui contient les "questions trouvées"
    let itemsContainer = document.getElementById('itemsContainer');
    // la div qui contient les "questions sélectionnées"
    let questionsContainer = document.getElementById('questionsContainer');
    // la liste des numéros de questions sélectionnées
    let numsQuestionsSelectionnees = [];
    let codeLatexAMC = "";
    let codeLatexMoodle = "";
    // let url = window.location.origin + window.location.pathname;
    let url = window.location.href;



    /*
        * Fonction qui normalise une chaîne de caractères en retirant les accents et les majuscules
        * @param {string} str - La chaîne de caractères à normaliser
        * @returns {string} La chaîne de caractères normalisée
    */
    function normalizeString(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    /**
     * Fonction qui change les résultats de recherche des questions en fonction des filtres de mots
     * 
     * @param {event} event - Bouton du clavier appuyé
     */
    function handleKeyPress(event) {
        fetchData();
    }

    /** 
     * Fonction déterminant tous les mots de recherche entrés par l'utilisateur en coupant la chaîne de caractères initiale
     * sur les caractères d'espace
     * 
     * @param {string} str - La chaîne de caractères contenant les mots
     * @returns {array} - Une liste dont les éléments sont chaque mot
     */
    function getMotsDeRecherche(str) {
        return str.split(/\s+/);
    }

    /** 
     * Fonction qui teste si tous les mots d'une liste sont présents dans une chaîne de caractère
     * 
     * @param {string} str - La chaîne de caractères où on vérifie la présence des mots
     * @param {string[]} wordsArray - La liste de mots dont on vérifie la présence
     * @returns {boolean} True si tous les mots sont présents dans la chaîne de caractères, false sinon.
     */
    function testPresenceMots(str, wordsArray) {
        const lowerCaseString = str.toLowerCase();

        for (let word of wordsArray) {
            const lowerCaseWord = word.toLowerCase();

            if (!lowerCaseString.includes(lowerCaseWord)) {
                return false;
            }
        }
        return true;
    }


    /*
        * Fonction qui récupère les données du fichier JSON et les affiche dans la div "resultats de la recherche"
    */
    function fetchData() {
        itemsContainer.innerHTML = "";
        fetch('https://raw.githubusercontent.com/Phil1010/quiz-exo7-stage2023/main/catalogue.json')
            .then(response => response.json())
            .then(data => {
                const searchString = normalizeString(motRechercher.value.trim().replace(/\s+/g, ' '));
                const listeMots = getMotsDeRecherche(searchString);
                data.forEach((element, index) => {
                    const normalizedText = normalizeString(element.texte);
                    // if (regex.test(normalizedText) && searchString !== '') {
                    // console.log(regex);
                    if (testPresenceMots(normalizedText, listeMots)) {
                        // Vérifier si l'élément est déjà dans la liste des questions sélectionnées
                        const isAlreadySelected = questionsSelectionnees.some(q => q.number === index);
                        if (!isAlreadySelected) {
                            resultatsDeRecherche.push(element);
                            itemsContainer.appendChild(createBoiteQuestion(index, element.texte));
                        }
                    }
                });
            });
    }


    /*
        * Fonction qui crée une boîte de question
        * @param {number} number - Le numéro de la question
        * @param {string} text - Le texte de la question
        * @returns {HTMLElement} La boîte de question complète
    */
    function createBoiteQuestion(number, text) {
        ;
        const card = document.createElement("div");
        card.className = "card";

        const items = document.createElement("div");
        items.className = "row valign-wrapper ";
        items.style.margin = "0%";


        const enonce = document.createElement("div");
        enonce.className = "col s10";
        enonce.style.margin = "-1%"
        enonce.textContent = number + ". " + text;

        const bouttonAjouterBox = document.createElement("bouttonAjouterBox");
        bouttonAjouterBox.className = "col s2 right-align";

        const boutonAjouter = document.createElement("button");
        boutonAjouter.className = "btn-floating btn-small";
        boutonAjouter.style.margin = "0%";
        boutonAjouter.textContent = "+";


        boutonAjouter.addEventListener("click", () => {
            const question = {
                number: number,
                text: text
            };
            questionsSelectionnees.push(question);
            numsQuestionsSelectionnees.push(number);
            card.remove();

            // Supprimer l'élément correspondant de resultatsDeRecherche
            const indexToRemove = resultatsDeRecherche.findIndex(q => q.number === number);
            if (indexToRemove !== -1) {
                resultatsDeRecherche.splice(indexToRemove, 1);
            }

            questionsContainer.appendChild(createBoiteQuestion(question.number, question.text));
            majURL();
        });

        items.appendChild(enonce);

        if (questionsSelectionnees.some(q => q.number === number) || questionsSelectionnees.some(q => q.number === parseInt(number))) {
            const bouttonMonter = createButton("⬆", () => moveQuestion(number, -1));
            const bouttonDescendre = createButton("⬇", () => moveQuestion(number, 1));
            const bouttonSupprimer = createButton("X", () => {
                const index = questionsSelectionnees.findIndex(q => q.number === parseInt(number));
                if (index !== -1) {
                    questionsSelectionnees.splice(index, 1);
                    numsQuestionsSelectionnees.splice(index, 1);
                    card.remove();
                    fetchData();
                }
                majURL();
            });

            items.appendChild(bouttonMonter);
            items.appendChild(bouttonDescendre);
            items.appendChild(bouttonSupprimer);

        } else {
            bouttonAjouterBox.appendChild(boutonAjouter);
            items.appendChild(bouttonAjouterBox);
        }

        card.appendChild(items);

        return card;
    }

    /*
        * Fonction qui crée un bouton
        * @param {string} label - Le texte du bouton
        * @param {function} onClick - La fonction à exécuter au clic
        * @returns {HTMLElement} Le bouton
    */
    function createButton(label, onClick) {
        console.log("CREATE BUTTON");
        const button = document.createElement("button");
        button.className = "btn-floating btn-small";
        button.textContent = label;
        button.addEventListener("click", onClick);
        button.style.margin = "2px";
        return button;
    }

    /*
        * Fonction qui déplace une question dans la liste des questions sélectionnées
        * @param {number} number - Le numéro de la question
        * @param {number} offset - Le décalage
    */
    function moveQuestion(number, offset) {
        console.log("MOVEQUESTION");
        const index = questionsSelectionnees.findIndex(q => q.number === parseInt(number));
        if (index > -1 && index + offset >= 0 && index + offset < questionsSelectionnees.length) {
            const temp = questionsSelectionnees[index];
            questionsSelectionnees[index] = questionsSelectionnees[index + offset];
            questionsSelectionnees[index + offset] = temp;

            const tempNum = numsQuestionsSelectionnees[index];
            numsQuestionsSelectionnees[index] = numsQuestionsSelectionnees[index + offset];
            numsQuestionsSelectionnees[index + offset] = tempNum;

            questionsContainer.innerHTML = "";
            questionsSelectionnees.forEach((question, index) => {
                questionsContainer.appendChild(createBoiteQuestion(question.number, question.text));
            });
        }
        majURL();
    }


    async function ouvrirCodeAMC() {
        codeLatexAMC = "";
        try {
            for (const num of numsQuestionsSelectionnees) {
                const fileName = `${100000 + num}.tex`;
                const response = await fetch(`https://raw.githubusercontent.com/Phil1010/quiz-exo7-stage2023/main/latex_amc/${fileName}`);
                const data = await response.text();
                codeLatexAMC += data;
            }

            // Créer un nouveau fichier texte avec l'extension .tex et le contenu concaténé
            const file = new File([codeLatexAMC], "questions.tex", {
                type: "text/plain",
            });

            // Créer une URL de l'objet file pour l'ouvrir dans un nouvel onglet
            const fileUrl = URL.createObjectURL(file);

            // Ouvrir le fichier dans un nouvel onglet
            window.open(fileUrl, "_blank");
        } catch (error) {
            console.error(error);
        }
    }

    async function ouvrirCodeMoodle() {
        codeLatexMoodle = "";
        try {
            for (const num of numsQuestionsSelectionnees) {
                const fileName = `${100000 + num}.tex`;
                const response = await fetch(`https://raw.githubusercontent.com/Phil1010/quiz-exo7-stage2023/main/latex_moodle/${fileName}`);
                const data = await response.text();
                codeLatexMoodle += data;
            }

            // Créer un nouveau fichier texte avec l'extension .tex et le contenu concaténé
            const file = new File([codeLatexMoodle], "questions.tex", {
                type: "text/plain",
            });

            // Créer une URL de l'objet file pour l'ouvrir dans un nouvel onglet
            const fileUrl = URL.createObjectURL(file);

            // Ouvrir le fichier dans un nouvel onglet
            window.open(fileUrl, "_blank");
        } catch (error) {
            console.error(error);
        }
    }

    function ouvrirAvecOverleaf() {
        console.log("ouvrirAvecOverleafFFFFFFFF");
    }

    function majURL() {
        url = "";
        if (numsQuestionsSelectionnees.length > 0) {
            url += "?listeQuestions=" + numsQuestionsSelectionnees.join(",");
            window.history.pushState("", "", url);
        }
        if (numsQuestionsSelectionnees.length == 0) {
            url = window.location.origin + window.location.pathname;
            window.history.pushState("", "", url);
        }
    }

    function prechargerListeExosSelectionnees() {
        if (window.location.search != "") { // S'il existe un paramètre dans l'URL
            console.log("URL IS :" + url);
            numsQuestionsSelectionnees = window.location.search.split("=")[1].split(",");
            console.log("QUESTIONS SELECTIONNEES DEPUIS LURL : " + numsQuestionsSelectionnees);
        }
        if (numsQuestionsSelectionnees.length > 0) {
            fetch('https://raw.githubusercontent.com/Phil1010/quiz-exo7-stage2023/main/catalogue.json')
                .then(response => response.json())
                .then(data => {
                    numsQuestionsSelectionnees.forEach((number, index) => {
                        const question = {
                            number: parseInt(number),
                            text: number.texte
                        };
                        questionsSelectionnees.push(question);
                        questionsContainer.appendChild(createBoiteQuestion(number, data[number].texte));
                    });
                });
        }
    }

    function copierLien() {
        // Get the text field
        // majURL();
        var dummyTextArea = document.createElement('textarea');
        dummyTextArea.value = window.location.href;
        document.body.appendChild(dummyTextArea);
        dummyTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(dummyTextArea);

        Materialize.toast('Copied !', 1500);

        // // Copy the text inside the text field
        // navigator.clipboard.writeText(copyText);
    }

    prechargerListeExosSelectionnees();
    fetchData();

</script>